<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.Default.css" />
  </head>

  <body style="margin:0px">
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <div id="map" style="height:100vh; width:100%;"></div>
    <table></table>

    <script src="./lib/leaflet/leaflet.js"></script>
    <script src="./lib/leaflet.markercluster.js"></script>
    <script src="./lib/d3dsv.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale.v3.min.js"></script>
    <script src="./lib/proj4-compressed.js"></script>
    <script src="./lib/proj4leaflet.js"></script>
    <script>
      let crs3035 = new L.Proj.CRS(
        "EPSG:3035",

        "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs",

        {
          origin: [0, 6000000],

          bounds: L.bounds([0, 0], [8000000, 6000000]),

          resolutions: [
            156543.03392804097,
            78271.51696402048,
            39135.75848201024,
            19567.87924100512,
            9783.93962050256,
            4891.96981025128,
            2445.98490512564,
            1222.99245256282,
            611.49622628141,
            305.748113140705,
            152.8740565703525,
            76.43702828517625,
            38.21851414258813,
            19.109257071294063,
            9.554628535647032,
            4.777314267823516,
            2.388657133911758,
            1.19432856695,
            0.597164283477939
          ]
        }
      );

      //get hospitals csv
      let request = new XMLHttpRequest();
      request.open(
        "GET",
        "https://raw.githubusercontent.com/eurostat/healthcare-services/master/data/csv/all.csv",
        true
      );

      request.onload = () => {
        if (request.status >= 200 && request.status < 400) {
          let hospitals = d3.csvParse(request.responseText);

          //change default marker
          var newIcon = L.icon({
            iconUrl: "lib/leaflet/images/marker-icon.png",
            iconAnchor: [7, 0]
          });
          L.Marker.mergeOptions({
            icon: newIcon
          });

          //build map
          let tiles = L.tileLayer(
            "https://europa.eu/webtools/rest/gisco/maps/wmts/OSMPositronBackground/EPSG3035/{z}/{x}/{y}.png",
            {
              maxZoom: 18,
              attribution:
                '&copy; <a href="//openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="https://ec.europa.eu/eurostat/web/gisco">GISCO</a>'
            }
          );
          let osm = L.tileLayer(
            "https://europa.eu/webtools/rest/gisco/maps/wmts/OSMCartoBackground/EPSG3035/{z}/{x}/{y}.png",
            {
              maxZoom: 18,
              attribution:
                '&copy; <a href="//openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="https://ec.europa.eu/eurostat/web/gisco">GISCO</a>'
            }
          );

          // let mcg = L.markerClusterGroup({
          //   chunkedLoading: true,
          //   //singleMarkerMode: true,
          //   maxClusterRadius: 40,
          //   spiderfyOnMaxZoom: true,
          //   showCoverageOnHover: false,
          //   removeOutsideVisibleBounds: true
          // });

          var circleScale = d3
            .scaleSqrt()
            .domain(d3.extent(hospitals, d => d.cap_beds)) //568158 37691912
            .range([100, 8000]); //metres

          let propCircles = L.layerGroup();
          let normalCircles = L.layerGroup();
          let defaultRadius = 2000; //metres

          for (let i = 0; i < hospitals.length; i++) {
            let a = hospitals[i];
            //clusters
            // let title = a.name;
            //let marker = L.marker(new L.LatLng(a.lat, a.lon, { title: title }));
            let popup = generatePopupString(a);
            //marker.bindPopup(popup);
            //mcg.addLayer(marker);
            //proportional circles
            if (a.cap_beds) {
              let r = circleScale(a.cap_beds);
              //let circle = L.circle([a.lat, a.lon], r);
              let circle = L.circle([a.lat, a.lon], r, {
                fillColor: "#708598",
                color: "#537898",
                weight: 1,
                fillOpacity: 0.6
              }).on({
                mouseover: function(e) {
                  //this.openPopup();
                  this.setStyle({ color: "yellow" });
                },
                mouseout: function(e) {
                  //this.closePopup();
                  this.setStyle({ color: "#537898" });
                }
              });
              circle.bindPopup(popup);
              propCircles.addLayer(circle);
            }

            //let circle = L.circle([a.lat, a.lon], r);
            let normalCircle = L.circle([a.lat, a.lon], defaultRadius, {
              fillColor: "#708598",
              color: "#537898",
              weight: 1,
              fillOpacity: 0.6
            }).on({
              mouseover: function(e) {
                //this.openPopup();
                this.setStyle({ color: "yellow" });
              },
              mouseout: function(e) {
                //this.closePopup();
                this.setStyle({ color: "#537898" });
              }
            });
            normalCircle.bindPopup(popup);
            normalCircles.addLayer(normalCircle);
          }

          let map = L.map("map", {
            center: L.latLng(52, 10),
            zoom: 5,
            layers: [tiles, normalCircles],
            renderer: L.canvas(),
            crs: crs3035
          });

          map.on("zoomend", function(e) {
            var currentZoom = map.getZoom();
            let newRadius;
            if (currentZoom >= 12) {
              newRadius = 100;
            } else if (currentZoom >= 10 && currentZoom <= 12) {
              newRadius = 500;
            } else {
              newRadius = defaultRadius;
            }
            normalCircles.eachLayer(function(layer) {
              if (layer._mradius !== newRadius) layer.setRadius(newRadius);
            });
          });

          //layer toggle
          var baseLayers = {
            Positron: tiles,
            OpenStreetMap: osm
          };
          var overlays = {
            "Healthcare Centres": normalCircles,
            "Bed Capacity": propCircles
          };
          L.control.layers(baseLayers, overlays).addTo(map);
        } else {
          // We reached our target server, but it returned an error
        }
      };

      request.onerror = function() {
        // There was a connection error of some sort
      };

      function generatePopupString(obj) {
        let i = 0;
        let string = "<table class='gisco-attribute-table'>";
        let style;

        for (var key in obj) {
          var value = obj[key];
          if (value) {
            i++;
            if (i % 2 == 0) {
              style = "background-color:#eaeaea; padding:4px;";
            } else {
              style = "padding:4px;";
            }
            string = string + "<tr style=" + style + ">";
            string =
              string +
              "<td><strong>" +
              key +
              "</strong></td>" +
              "<td>" +
              value +
              "</td>";
            string = string + "</tr>";
          }
        }

        string = string + "</table>";
        return string;
      }

      request.send();

      toRadius = function(val) {
        return 1 * 0.005 * Math.sqrt(val);
      };
    </script>
  </body>
</html>