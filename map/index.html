<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.Default.css" />
    <style>
      #layDiv {
        z-index: 9999999;
        position: absolute;
        padding: 6px;
        right: 10px;
        top: 10px;
      }
      #circleLegend {
        top: 120px;
        left: 10px;
        position: absolute;
        z-index: 999999999;
        padding: 6px;
      }
      .leaflet-popup-content {
        overflow: auto !important;
      }
    </style>
  </head>

  <body style="margin:0px">
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <div id="map" style="height:100vh; width:100%;"></div>
    <table></table>

    <script src="./lib/leaflet/leaflet.js"></script>
    <script src="./lib/leaflet.markercluster.js"></script>
    <script src="./lib/d3.min.js"></script>
    <script src="./lib/proj4-compressed.js"></script>
    <script src="./lib/proj4leaflet.js"></script>
    <script>
      let crs3035 = new L.Proj.CRS(
        "EPSG:3035",

        "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs",

        {
          origin: [0, 6000000],

          bounds: L.bounds([0, 0], [8000000, 6000000]),

          resolutions: [
            156543.03392804097,
            78271.51696402048,
            39135.75848201024,
            19567.87924100512,
            9783.93962050256,
            4891.96981025128,
            2445.98490512564,
            1222.99245256282,
            611.49622628141,
            305.748113140705,
            152.8740565703525,
            76.43702828517625,
            38.21851414258813,
            19.109257071294063,
            9.554628535647032,
            4.777314267823516,
            2.388657133911758,
            1.19432856695,
            0.597164283477939
          ]
        }
      );

      //get hospitals csv
      let request = new XMLHttpRequest();
      request.open(
        "GET",
        "https://raw.githubusercontent.com/eurostat/healthcare-services/master/data/csv/all.csv",
        true
      );

      request.onload = () => {
        if (request.status >= 200 && request.status < 400) {
          let hospitals = d3.csvParse(request.responseText);

          //change default marker
          var newIcon = L.icon({
            iconUrl: "lib/leaflet/images/marker-icon.png",
            iconAnchor: [7, 0]
          });
          L.Marker.mergeOptions({
            icon: newIcon
          });

          //build map
          let tiles = L.tileLayer(
            "https://europa.eu/webtools/rest/gisco/maps/wmts/OSMPositronBackground/EPSG3035/{z}/{x}/{y}.png",
            {
              maxZoom: 18,
              attribution:
                '&copy; <a href="//openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="https://ec.europa.eu/eurostat/web/gisco">GISCO</a>'
            }
          );

          tiles.layerId = "basemap";

          // let mcg = L.markerClusterGroup({
          //   chunkedLoading: true,
          //   //singleMarkerMode: true,
          //   maxClusterRadius: 40,
          //   spiderfyOnMaxZoom: true,
          //   showCoverageOnHover: false,
          //   removeOutsideVisibleBounds: true
          // });

          var circleScale = d3
            .scaleSqrt()
            .domain(d3.extent(hospitals, d => d.cap_beds))
            .range([100, 8000]); //metres

          let propCircles = L.layerGroup();
          let normalCircles = L.layerGroup();
          let defaultRadius = 2000; //metres

          for (let i = 0; i < hospitals.length; i++) {
            let a = hospitals[i];
            //clusters
            // let title = a.name;
            //let marker = L.marker(new L.LatLng(a.lat, a.lon, { title: title }));
            let popup = generatePopupString(a);
            //marker.bindPopup(popup);
            //mcg.addLayer(marker);
            //proportional circles
            if (a.cap_beds) {
              let r = circleScale(a.cap_beds);
              //let circle = L.circle([a.lat, a.lon], r);
              let circle = L.circle([a.lat, a.lon], r, {
                fillColor: "#708598",
                color: "#537898",
                weight: 1,
                fillOpacity: 0.6
              }).on({
                mouseover: function(e) {
                  //this.openPopup();
                  this.setStyle({ color: "yellow" });
                },
                mouseout: function(e) {
                  //this.closePopup();
                  this.setStyle({ color: "#537898" });
                }
              });
              circle.bindPopup(popup);
              propCircles.addLayer(circle);
            }

            //let circle = L.circle([a.lat, a.lon], r);
            let normalCircle = L.circle([a.lat, a.lon], defaultRadius, {
              fillColor: "#708598",
              color: "#537898",
              weight: 1,
              fillOpacity: 0.6
            }).on({
              mouseover: function(e) {
                //this.openPopup();
                this.setStyle({ color: "yellow" });
              },
              mouseout: function(e) {
                //this.closePopup();
                this.setStyle({ color: "#537898" });
              }
            });
            normalCircle.bindPopup(popup);
            normalCircles.addLayer(normalCircle);
          }

          let map = L.map("map", {
            center: L.latLng(52, 10),
            zoom: 5,
            layers: [tiles, normalCircles],
            renderer: L.canvas(),
            crs: crs3035
          });

          map.on("zoomend", function(e) {
            var currentZoom = map.getZoom();
            let newRadius;
            if (currentZoom >= 12) {
              newRadius = 100;
            } else if (currentZoom >= 10 && currentZoom <= 12) {
              newRadius = 500;
            } else {
              newRadius = defaultRadius;
            }
            normalCircles.eachLayer(function(layer) {
              if (layer._mradius !== newRadius) layer.setRadius(newRadius);
            });
          });

          //layer toggle
          // var baseLayers = {
          //   Positron: tiles,
          //   OpenStreetMap: osm
          // };
          // var overlays = {
          //   "Healthcare Centres": normalCircles,
          //   "Bed Capacity": propCircles
          // };
          // L.control.layers(baseLayers, overlays).addTo(map);

          //build control panel
          let layDiv = document.createElement("div");
          layDiv.classList.add(
            "leaflet-control-layers",
            "leaflet-control",
            "leaflet-container"
          );
          layDiv.id = "layDiv";

          let form = document.createElement("form");
          layDiv.appendChild(form);
          document.body.appendChild(layDiv);

          //radio
          let rdDefault = document.createElement("label");
          let div = document.createElement("div");
          rdDefault.appendChild(div);
          let input = document.createElement("input");
          input.classList.add("leaflet-control-layers-selector");
          input.name = "layerChoice";
          input.checked = "checked";
          input.value = "def";
          input.type = "radio";
          div.appendChild(input);
          let span = document.createElement("span");
          span.innerHTML = "Healthcare Services <br>";
          div.appendChild(span);
          //radio
          let rdBeds = document.createElement("label");
          let div2 = document.createElement("div");
          rdBeds.appendChild(div);
          let input2 = document.createElement("input");
          input2.classList.add("leaflet-control-layers-selector");
          input2.name = "layerChoice";
          input2.id = "rdBedsInput";
          //input2.checked = "false";
          input2.value = "beds";
          input2.type = "radio";
          div.appendChild(input2);
          let span2 = document.createElement("span");
          span2.innerHTML = "By Number of Beds";
          span2.for = "rdBedsInput";
          div.appendChild(span2);

          form.appendChild(rdDefault);
          form.appendChild(rdBeds);

          //change layer selection
          let inputs = document.querySelectorAll(
            "input[type=radio][name=layerChoice]"
          );

          inputs.forEach(input => {
            input.onchange = function() {
              //remove all layers
              map.eachLayer(function(layer) {
                if (layer.layerId !== "basemap") map.removeLayer(layer);
              });
              if (this.value == "def") {
                //map.addLayer(tiles)
                map.addLayer(normalCircles);
                //$("#bedsLgd").hide();
                //$("#dateLgd").hide();
              } else if (this.value == "beds") {
                map.addLayer(propCircles);
                //$("#speedLgd").show();
                //$("#dateLgd").hide();
              }
            };
          });

          //circle size legend
          // let svg = d3.create("svg").attr("id", "circleLegend");
          // svg.style("top", "20%");
          // svg.style("left", "5%");
          // document.body.appendChild(svg.node());
          // const legC = svg
          //   .append("g")
          //   .attr("fill", "#444")
          //   //.attr("transform", "translate(50,130)")
          //   .attr("text-anchor", "right")
          //   .style("font", "10px sans-serif")
          //   .selectAll("g")
          //   .data([1000, 500, 100])
          //   .join("g");
          // legC
          //   .append("circle")
          //   .attr("fill", "none")
          //   .attr("stroke", "#444")
          //   .attr("cy", 40)
          //   .attr("r", circleScale);
          // legC
          //   .append("text")
          //   .attr("y", 40)
          //   .attr("x", 30)
          //   .attr("dy", "1.3em")
          //   .text(d3.format(".1s"));
        } else {
          // We reached our target server, but it returned an error
        }
      };

      request.onerror = function() {
        // There was a connection error of some sort
      };

      function generatePopupString(obj) {
        let i = 0;
        let string = "<table class='gisco-attribute-table'>";
        let style;

        for (var key in obj) {
          var value = obj[key];
          if (value) {
            i++;
            if (i % 2 == 0) {
              style = "background-color:#eaeaea; padding:4px;";
            } else {
              style = "padding:4px;";
            }
            string = string + "<tr style=" + style + ">";
            string =
              string +
              "<td><strong>" +
              key +
              "</strong></td>" +
              "<td>" +
              value +
              "</td>";
            string = string + "</tr>";
          }
        }

        string = string + "</table>";
        return string;
      }

      request.send();

      toRadius = function(val) {
        return 1 * 0.005 * Math.sqrt(val);
      };
    </script>
  </body>
</html>
