<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Healthcare Services</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.Default.css" />
    <style>
      .leaflet-popup-content-wrapper {
        overflow: auto !important;
      }
    </style>
  </head>

  <body style="margin:0px">
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <div id="map" style="height:100vh; width:100%;"></div>
    <script src="./lib/leaflet/leaflet.js"></script>
    <script src="./lib/leaflet.markercluster.js"></script>
    <script src="./lib/d3dsv.js"></script>
    <script>
      //get hospitals
      let request = new XMLHttpRequest();
      request.open(
        "GET",
        "https://raw.githubusercontent.com/eurostat/healthcare-services/master/data/csv/all.csv",
        true
      );

      request.onload = () => {
        if (request.status >= 200 && request.status < 400) {
          let hospitals = d3.csvParse(request.responseText);

          var newIcon = L.icon({
            iconUrl: "lib/images/marker-icon.svg",
            iconAnchor: [7, 0]
          });
          L.Marker.mergeOptions({
            icon: newIcon
          });

          //build map
          let tiles = L.tileLayer(
            "https://europa.eu/webtools/rest/gisco/maps/wmts/OSMPositronBackground/EPSG3857/{z}/{x}/{y}.png",
            {
              maxZoom: 18,
              attribution:
                '&copy; <a href="//openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="https://ec.europa.eu/eurostat/web/gisco">GISCO</a>'
            }
          );
          let map = L.map("map", {
            center: L.latLng(52, 10),
            zoom: 5,
            layers: [tiles],
            maxZoom: 18
          });

          let mcg = L.markerClusterGroup({
            chunkedLoading: true,
            //singleMarkerMode: true,
            spiderfyOnMaxZoom: true,
            maxClusterRadius: 30
          });

          for (let i = 0; i < hospitals.length; i++) {
            let a = hospitals[i];
            let title = a.name;
            let marker = L.marker(new L.LatLng(a.lat, a.lon, { title: title }));
            let popup = generatePopupString(a);
            marker.bindPopup(popup);
            mcg.addLayer(marker);
          }
          map.addLayer(mcg);
        } else {
          // We reached our target server, but it returned an error
        }
      };

      request.onerror = function() {
        // There was a connection error of some sort
      };

      function generatePopupString(obj) {
        let i = 0;
        let string = "<table class='gisco-attribute-table'>";
        let style;

        for (var key in obj) {
          var value = obj[key];
          if (value) {
            i++;
            if (i % 2 == 0) {
              style = "background-color:#eaeaea; padding:4px;";
            } else {
              style = "padding:4px;";
            }
            string = string + "<tr style=" + style + ">";
            string =
              string +
              "<td><strong>" +
              key +
              "</strong></td>" +
              "<td>" +
              value +
              "</td>";
            string = string + "</tr>";
          }
        }

        string = string + "</table>";
        return string;
      }

      request.send();
    </script>
  </body>
</html>
