<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./lib/leaflet.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.css" />
    <link rel="stylesheet" href="./lib/MarkerCluster.Default.css" />
  </head>

  <body style="margin:0px">
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <div id="map" style="height:100vh; width:100%;"></div>
    <script src="./lib/leaflet/leaflet.js"></script>
    <script src="./lib/leaflet.markercluster.js"></script>
    <script src="./lib/d3dsv.js"></script>
    <script src="./lib/proj4-compressed.js"></script>
    <script src="./lib/proj4leaflet.js"></script>
    <script>
      let crs3035 = new L.Proj.CRS(
        "EPSG:3035",

        "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs",

        {
          origin: [0, 6000000],

          bounds: L.bounds([0, 0], [8000000, 6000000]),

          resolutions: [
            156543.03392804097,
            78271.51696402048,
            39135.75848201024,
            19567.87924100512,
            9783.93962050256,
            4891.96981025128,
            2445.98490512564,
            1222.99245256282,
            611.49622628141,
            305.748113140705,
            152.8740565703525,
            76.43702828517625,
            38.21851414258813,
            19.109257071294063,
            9.554628535647032,
            4.777314267823516,
            2.388657133911758,
            1.19432856695,
            0.597164283477939
          ]
        }
      );

      //get hospitals csv
      let request = new XMLHttpRequest();
      request.open(
        "GET",
        "https://raw.githubusercontent.com/eurostat/healthcare-services/master/data/csv/all.csv",
        true
      );

      request.onload = () => {
        if (request.status >= 200 && request.status < 400) {
          let hospitals = d3.csvParse(request.responseText);

          //build map
          let tiles = L.tileLayer(
            "http://gisco.northeurope.cloudapp.azure.com/maps/wmts/OSMCartoComposite/EPSG3035/{z}/{x}/{y}.png",
            {
              maxZoom: 18,
              attribution:
                '&copy; <a href="//openstreetmap.org/copyright">OpenStreetMap</a> contributors,Points &copy 2012 LINZ'
            }
          );
          let map = L.map("map", {
            center: L.latLng(52, 10),
            zoom: 5,
            layers: [tiles],
            crs: crs3035
          });

          let mcg = L.markerClusterGroup({
            chunkedLoading: true,
            //singleMarkerMode: true,
            //spiderfyOnMaxZoom: false
            showCoverageOnHover: false,
            removeOutsideVisibleBounds: true //for dealing with 3035
          });

          for (let i = 0; i < hospitals.length; i++) {
            let a = hospitals[i];
            let title = a.name;
            let marker = L.marker(new L.LatLng(a.lat, a.lon, { title: title }));
            let popup = generatePopupString(a);
            marker.bindPopup(popup);
            mcg.addLayer(marker);
          }
          map.addLayer(mcg);
        } else {
          // We reached our target server, but it returned an error
        }
      };

      request.onerror = function() {
        // There was a connection error of some sort
      };

      function generatePopupString(obj) {
        let i = 0;
        let string = "<table class='gisco-attribute-table'>";
        let style;

        for (var key in obj) {
          var value = obj[key];
          if (value) {
            i++;
            if (i % 2 == 0) {
              style = "background-color:#eaeaea; padding:4px;";
            } else {
              style = "padding:4px;";
            }
            string = string + "<tr style=" + style + ">";
            string =
              string +
              "<td><strong>" +
              key +
              "</strong></td>" +
              "<td>" +
              value +
              "</td>";
            string = string + "</tr>";
          }
        }

        string = string + "</table>";
        return string;
      }

      request.send();
    </script>
  </body>
</html>
