<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
  <!--<![endif]-->
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
    <style>
      #layDiv {
        z-index: 9999999;
        position: absolute;
        padding: 6px;
        right: 10px;
        top: 10px;
      }
      #circleLegend {
        top: 120px;
        left: 10px;
        position: absolute;
        z-index: 999999999;
        padding: 6px;
      }
      .leaflet-popup-content {
        overflow: auto !important;
      }
      /* DISCLAIMER  */

      .disclaimerButton {
        margin-right: 3px;
      }

      #referenceDataButton {
        float: right;
        margin-top: 3px;
        color: #fff;
        background-color: #337ab7;
        border-color: #2e6da4;
        margin-bottom: 0;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        -ms-touch-action: manipulation;
        touch-action: manipulation;
        cursor: pointer;
        background-image: none;
        border: 1px solid transparent;
        padding: 6px 12px;
        font-size: 14px;
        line-height: 1.42857143;
        border-radius: 4px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        text-decoration: none;
      }
      #referenceDataButton:hover {
        color: #fff;
        background-color: #286090;
        border-color: #204d74;
      }

      /* The popup */
      .attributionDiv {
        visibility: hidden;
        position: absolute;
        bottom: 4%;
        right: 2%;
        z-index: 9999999;
        width: 53vh;
        text-align: justify;
        background: #f5f5f5;
        color: #666;
        padding: 20px;
        border: 1px solid black;
        border-radius: 5px;
      }

      /* disclaimer arrow */
      #disclaimerText::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 96%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #555 transparent transparent transparent;
      }

      #sourcesText::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 90%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #555 transparent transparent transparent;
      }

      .close {
        position: absolute;
        top: 2px;
        right: 4px;
        background: unset;
        border: none;
        cursor: pointer;
      }

      /* Toggle this class - hide and show the disclaimer */

      .show {
        visibility: visible !important;
        -webkit-animation: fadeIn 1s;
        animation: fadeIn 1s;
      }

      .hide {
        visibility: hidden !important;
        -webkit-animation: fadeIn 1s;
        animation: fadeIn 1s;
      }

      /* Add animation (fade in the disclaimer popup) */

      @-webkit-keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .leaflet-container .leaflet-control-attribution {
        margin-bottom: 5px;
      }
      a {
        color: #337ab7;
        text-decoration: none;
      }
      a:hover {
        color: #23527c;
        text-decoration: underline;
      }
    </style>
  </head>

  <body style="margin:0px">
    <!--[if lt IE 7]>
      <p class="browsehappy">
        You are using an <strong>outdated</strong> browser. Please
        <a href="#">upgrade your browser</a> to improve your experience.
      </p>
    <![endif]-->
    <div id="map" style="height:100vh; width:100%;"></div>
    <div class="attributionDiv" id="disclaimerText">
      <span class="attributionText"
        >The designations employed and the presentation of material on the map
        do not imply the expression of any opinion whatsoever on the part of the
        European Union concerning the legal status of any country, territory or
        area or of its authorities, or concerning the delimitation of its
        frontiers or boundaries. Kosovo* - This designation is without prejudice
        to positions on status, and is in line with UNSCR 1244/1999 and the ICJ
        Opinion on the Kosovo declaration of independence.

        <button
          type="button"
          class="close"
          aria-label="Close"
          onclick="hideDisclaimer()"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </span>
    </div>

    <div class="attributionDiv" id="sourcesText">
      <span class="attributionText"
        ><button
          type="button"
          class="close"
          aria-label="Close"
          onclick="hideSources()"
        >
          <span aria-hidden="true">&times;</span>
        </button>

        <a
          href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data"
          id="referenceDataButton"
          class="btn btn-sm btn-primary"
          target="_blank"
          role="button"
          >See reference data</a
        >
      </span>
    </div>
    <table></table>

    <script src="./lib/leaflet/leaflet.js"></script>
    <!-- <script src="./lib/leaflet.markercluster.js"></script> -->
    <script src="./lib/d3.min.js"></script>
    <script src="./lib/proj4-compressed.js"></script>
    <script src="./lib/proj4leaflet.js"></script>
    <script>
      //define projection
      let crs3035 = new L.Proj.CRS(
        "EPSG:3035",
        "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs",
        {
          origin: [0, 6000000],
          bounds: L.bounds([0, 0], [8000000, 6000000]),
          resolutions: [
            156543.03392804097,
            78271.51696402048,
            39135.75848201024,
            19567.87924100512,
            9783.93962050256,
            4891.96981025128,
            2445.98490512564,
            1222.99245256282,
            611.49622628141,
            305.748113140705,
            152.8740565703525,
            76.43702828517625,
            38.21851414258813,
            19.109257071294063,
            9.554628535647032,
            4.777314267823516,
            2.388657133911758,
            1.19432856695,
            0.597164283477939
          ]
        }
      );

      //get hospitals csv
      let request = new XMLHttpRequest();
      request.open(
        "GET",
        "https://raw.githubusercontent.com/eurostat/healthcare-services/master/data/csv/all.csv",
        true
      );

      request.onload = () => {
        if (request.status >= 200 && request.status < 400) {
          let hospitals = d3.csvParse(request.responseText);

          //change default marker
          var newIcon = L.icon({
            iconUrl: "lib/leaflet/images/marker-icon.png",
            iconAnchor: [7, 0]
          });
          L.Marker.mergeOptions({
            icon: newIcon
          });

          //define basemap(s)
          let tiles = L.tileLayer(
            "https://europa.eu/webtools/rest/gisco/maps/wmts/OSMPositronBackground/EPSG3035/{z}/{x}/{y}.png",
            {
              maxZoom: 18
            }
          );

          tiles.layerId = "basemap";

          // let mcg = L.markerClusterGroup({
          //   chunkedLoading: true,
          //   //singleMarkerMode: true,
          //   maxClusterRadius: 40,
          //   spiderfyOnMaxZoom: true,
          //   showCoverageOnHover: false,
          //   removeOutsideVisibleBounds: true
          // });

          // define d3 scale for sizing circles
          var circleScale = d3
            .scaleSqrt()
            .domain(d3.extent(hospitals, d => d.cap_beds))
            .range([100, 8000]); //metres
          //define circle layers
          let propCircles = L.layerGroup();
          let normalCircles = L.layerGroup();
          let defaultRadius = 2000; //metres

          //add each hospital to the different layerGroups
          for (let i = 0; i < hospitals.length; i++) {
            let a = hospitals[i];
            let popup = generatePopupString(a);
            //proportional circles
            if (a.cap_beds) {
              let r = circleScale(a.cap_beds);
              //let circle = L.circle([a.lat, a.lon], r);
              let circle = L.circle([a.lat, a.lon], r, {
                fillColor: "#708598",
                color: "#537898",
                weight: 1,
                fillOpacity: 0.6
              }).on({
                mouseover: function(e) {
                  //this.openPopup();
                  this.setStyle({ color: "yellow" });
                },
                mouseout: function(e) {
                  //this.closePopup();
                  this.setStyle({ color: "#537898" });
                }
              });
              circle.bindPopup(popup);
              propCircles.addLayer(circle);
            }

            //let circle = L.circle([a.lat, a.lon], r);
            let normalCircle = L.circle([a.lat, a.lon], defaultRadius, {
              fillColor: "#708598",
              color: "#537898",
              weight: 1,
              fillOpacity: 0.6
            }).on({
              mouseover: function(e) {
                //this.openPopup();
                this.setStyle({ color: "yellow" });
              },
              mouseout: function(e) {
                //this.closePopup();
                this.setStyle({ color: "#537898" });
              }
            });
            normalCircle.bindPopup(popup);
            normalCircles.addLayer(normalCircle);
          }

          let map = L.map("map", {
            center: L.latLng(52, 10),
            zoom: 5,
            layers: [tiles, normalCircles],
            renderer: L.canvas(),
            crs: crs3035,
            attributionControl: false
          });

          //add disclaimer & sources buttons
          L.control.scale().addTo(map);
          var attribution = L.control
            .attribution({
              prefix:
                '<a href="http://leafletjs.com/" title="A JS library for interactive maps" target"_blank">Leaflet</a>'
            })
            .addTo(map);
          {
            //add button
            attribution.addAttribution(
              '<button type="button" class="disclaimerButton" onclick="showSources()">Sources</button><button type="button" class="disclaimerButton" onclick="showDisclaimer()">Disclaimer</button>'
            );

            var sourcesText = document.getElementById("sourcesText");
            sourcesText.innerHTML =
              "Administrative boundaries: &copy; <a href='http://www.eurogeographics.org/' title='EuroGeographics' target='_blank'>EuroGeographics</a> &copy; <a href='http://www.fao.org/' title='UN-FAO' target='_blank'>UN-FAO</a> &copy; <a href='http://www.instat.gov.al' title='INSTAT' target='_blank'>INSTAT</a> &copy; <a href='http://www.turkstat.gov.tr' title='Turkstat' target='_blank'>Turkstat</a>, Cartography: <a href='https://ec.europa.eu/eurostat/en/web/gisco' title='Eurostat - GISCO' target='_blank'>Eurostat - GISCO</a>, 2019" +
              sourcesText.innerHTML;
            // add button click event
            window.showDisclaimer = function() {
              var popup = document.getElementById("disclaimerText");
              popup.classList.toggle("show");
            };

            window.hideDisclaimer = function() {
              var popup = document.getElementById("disclaimerText");
              popup.classList.toggle("show");
            };

            // add button click event
            window.showSources = function() {
              var popup = document.getElementById("sourcesText");
              popup.classList.toggle("show");
            };

            window.hideSources = function() {
              var popup = document.getElementById("sourcesText");
              popup.classList.toggle("show");
            };
          }

          map.on("zoomend", function(e) {
            var currentZoom = map.getZoom();
            let newRadius;
            if (currentZoom >= 12) {
              newRadius = 100;
            } else if (currentZoom >= 10 && currentZoom <= 12) {
              newRadius = 500;
            } else {
              newRadius = defaultRadius;
            }
            normalCircles.eachLayer(function(layer) {
              if (layer._mradius !== newRadius) layer.setRadius(newRadius);
            });
          });

          //layer toggle
          // var baseLayers = {
          //   Positron: tiles,
          //   OpenStreetMap: osm
          // };
          // var overlays = {
          //   "Healthcare Centres": normalCircles,
          //   "Bed Capacity": propCircles
          // };
          // L.control.layers(baseLayers, overlays).addTo(map);

          //build control panel
          let layDiv = document.createElement("div");
          layDiv.classList.add(
            "leaflet-control-layers",
            "leaflet-control",
            "leaflet-container"
          );
          layDiv.id = "layDiv";

          let form = document.createElement("form");
          layDiv.appendChild(form);
          document.body.appendChild(layDiv);

          //radio
          let rdDefault = document.createElement("label");
          let div = document.createElement("div");
          rdDefault.appendChild(div);
          let input = document.createElement("input");
          input.classList.add("leaflet-control-layers-selector");
          input.name = "layerChoice";
          input.checked = "checked";
          input.value = "def";
          input.type = "radio";
          div.appendChild(input);
          let span = document.createElement("span");
          span.innerHTML = "Healthcare Services <br>";
          div.appendChild(span);
          //radio
          let rdBeds = document.createElement("label");
          let div2 = document.createElement("div");
          rdBeds.appendChild(div);
          let input2 = document.createElement("input");
          input2.classList.add("leaflet-control-layers-selector");
          input2.name = "layerChoice";
          input2.id = "rdBedsInput";
          //input2.checked = "false";
          input2.value = "beds";
          input2.type = "radio";
          div.appendChild(input2);
          let span2 = document.createElement("span");
          span2.innerHTML = "By Number of Beds";
          span2.for = "rdBedsInput";
          div.appendChild(span2);

          form.appendChild(rdDefault);
          form.appendChild(rdBeds);

          //change layer selection
          let inputs = document.querySelectorAll(
            "input[type=radio][name=layerChoice]"
          );

          inputs.forEach(input => {
            input.onchange = function() {
              //remove all layers
              map.eachLayer(function(layer) {
                if (layer.layerId !== "basemap") map.removeLayer(layer);
              });
              if (this.value == "def") {
                //map.addLayer(tiles)
                map.addLayer(normalCircles);
                map.options.renderer._update();
                //$("#bedsLgd").hide();
                //$("#dateLgd").hide();
              } else if (this.value == "beds") {
                map.addLayer(propCircles);
                map.options.renderer._update();
                //$("#speedLgd").show();
                //$("#dateLgd").hide();
              }
            };
          });

          //circle size legend
          // let svg = d3.create("svg").attr("id", "circleLegend");
          // svg.style("top", "20%");
          // svg.style("left", "5%");
          // document.body.appendChild(svg.node());
          // const legC = svg
          //   .append("g")
          //   .attr("fill", "#444")
          //   //.attr("transform", "translate(50,130)")
          //   .attr("text-anchor", "right")
          //   .style("font", "10px sans-serif")
          //   .selectAll("g")
          //   .data([1000, 500, 100])
          //   .join("g");
          // legC
          //   .append("circle")
          //   .attr("fill", "none")
          //   .attr("stroke", "#444")
          //   .attr("cy", 40)
          //   .attr("r", circleScale);
          // legC
          //   .append("text")
          //   .attr("y", 40)
          //   .attr("x", 30)
          //   .attr("dy", "1.3em")
          //   .text(d3.format(".1s"));
        } else {
          // We reached our target server, but it returned an error
        }
      };

      request.onerror = function() {
        // There was a connection error of some sort
      };

      function generatePopupString(obj) {
        let i = 0;
        let string = "<table class='gisco-attribute-table'>";
        let style;

        for (var key in obj) {
          var value = obj[key];
          if (value) {
            i++;
            if (i % 2 == 0) {
              style = "background-color:#eaeaea; padding:4px;";
            } else {
              style = "padding:4px;";
            }
            string = string + "<tr style=" + style + ">";
            string =
              string +
              "<td><strong>" +
              key +
              "</strong></td>" +
              "<td>" +
              value +
              "</td>";
            string = string + "</tr>";
          }
        }

        string = string + "</table>";
        return string;
      }

      request.send();

      toRadius = function(val) {
        return 1 * 0.005 * Math.sqrt(val);
      };
    </script>
  </body>
</html>
